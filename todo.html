<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TASKIN</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.7/axios.min.js"></script>
    <script src="https://kit.fontawesome.com/106cc8f62a.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="todo.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Monoton&family=Orbitron:wght@400..900&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Monoton&family=Orbitron:wght@400..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Monoton&family=Orbitron:wght@400..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
</head>
<body>
    <main>
        <nav>
             <div class="navbar">
            <div class="logo">
                <img id="logo-img" src="/public/timage.png" height="38px" width="38px">
                <p id="logo-name">TASKIN</p>
            </div>
            <div class="signin-buttons">
                 <a class="button">Sign In</a>
                 <button id="signup" >
                    <p id="signup-txt"> Sign Up Free</p>
                   <div id="arrow"><img src="/public/6image.png" height="30px" width="30px" ></div>
                 </button>
            </div>
        </div>
        </nav>
        <div id="modal" class="hiding">
                   <div id="task-modal">
                         <form>
                            <p id="task-modal-heading">Add Your Task</p>
                            <input id="task-input" type="text" placeholder="Create New Task">
                            <textarea id="task-desc" name="description" placeholder="Add your Notes(optional)"></textarea>
                            <div id="meta-data">
                            <input type="date" id="due-date">
                            <select id="priority"name="Priority" required="">
                                 <option value="" disabled selected>Add Priority</option>
                                  <option value="Low">Low</option>
                                   <option value="Medium">Medium</option>
                                   <option value="High">High</option>
                           </select>
                            <select id="status"name="status" required="">
                                 <option value="" disabled selected>Select Status Of Task</option>
                                  <option value="To Do">To Do</option>
                                   <option value="In Progress">In Progress</option>
                                   <option value="Completed">Completed</option>
                           </select>
                            </div>
                           <hr>
                           <div id="cancel-save-but">
                            <button type="button" class="cancel-save-but" onclick="removeModal()">Cancel</button>
                           <button type="button" class="cancel-save-but" onclick="takeInfo()">Save Task</button>
                           </div>
                         </form>
                   </div>
            </div>
        <div class="hamburger" id="hamburger-collapse">
              <i class="fa-solid fa-bars" style="font-size: 19px;"></i>
        </div>
        <div id="container">
       <div id="hero-section">
             <div class="main-content">
                     <div id="intro-bar">
                         <p id="greeting"></p>
                         <div id="date"></div>
                     </div>
                     <div class="todo-container">
                        <div class="todo-column">
                            <div class="container-header">
                                <p><i class="fa-solid fa-calendar-check"></i>
                                    All To-Dos</p>
                                    <div >
                                        <button class="addtodo-but" onclick="presentForm()">Add Todo
                                            <i class="fa-solid fa-circle-plus"></i>
                                        </button>
                                    </div>
                            </div>
                            <div id="all-todo" class="todo-task">
                                 <span id="all-todos" class="no-task">
                                    No Tasks to Display!!! Create a task using Add Todo <i class="fa-solid fa-circle-plus"></i> Button!!
                                 </span>
                            </div>
                        </div>
                        <div class="todo-column">
                            <div class="container-header">
                                <p><i class="fa-solid fa-hourglass-half"></i>
                                    In Progess</p>
                                    <div>
                                        <button class="addtodo-but"  onclick="presentForm()">Add Todo
                                            <i class="fa-solid fa-circle-plus"></i>
                                        </button>
                                    </div>
                            </div>
                             <div id="inprogress-todo-task" class="todo-task">
                                 <span id="inprogress-todo" class="no-task">
                                   No Tasks in Progress!!! Add a task by Dragging and Dropping here or by Editing its Status to 'In Progress'.
                                 </span>
                            </div>
                        </div>
                        <div class="todo-column">
                            <div class="container-header">
                                <p><i class="fa-solid fa-square-check"></i>
                                    Done</p>
                                    <div >
                                        <button class="addtodo-but"  onclick="presentForm()">Add Todo
                                            <i class="fa-solid fa-circle-plus"></i>
                                        </button>
                                    </div>
                            </div>
                             <div id="done-todo-task" class="todo-task">
                                 <span id="done-todo" class="no-task">
                                  No Tasks Completed!!! Add a task by Dragging and Dropping here or by marking its Status to Complete.
                                 </span>
                            </div>
                        </div>
                     </div>
             </div>
       </div>
       </div>
    </main>
    <script>
         const months = [
  "January", "February", "March", "April", "May", "June",
  "July", "August", "September", "October", "November", "December"
   ];
        const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        let now=new Date();
        let hour=now.getHours();
        let date=now.getDate();
        let dayindex=now.getDay();
        let month=now.getMonth();
        let year=now.getFullYear();
        let greeting="";
       if(hour>=5&&hour<12) {
                greeting="Good Morning!";
         } else if(hour>=12&&hour<17) {
                greeting="Good Afternoon!";
         }else if(hour>=17&&hour<21) {
               greeting="Good Evening!";
        }else{
              greeting="Good Night!";
        }
      document.querySelector("#date").innerHTML="Today, "+daysOfWeek[dayindex]+" "+months[month]+" "+"0"+date+" "+year;
        let username="";
        const token=localStorage.getItem("authToken");
        async function myinfo(){
            let res=await axios.get("http://localhost:3000/todo/",{
                headers:{
                    Authorization:token,
                }
            })
            console.log(res.data);




            function todoComp(i){
               let child=document.querySelector("#all-todos");
            let finalparent=document.querySelector("#all-todo");
            let secfinalparent=document.querySelector("#inprogress-todo-task");
            let thirdfinalparent=document.querySelector("#done-todo-task");
            if(child) finalparent.removeChild(child);
            let parent=document.createElement("div");
            parent.setAttribute("class","parent");
            let newchild=document.createElement("div");
            newchild.setAttribute("class","newchild");
            let firstchild=document.createElement("div");
            firstchild.setAttribute("class","firstchild");
            firstchild.innerHTML=(res.data[i].completed==false)?"Pending":"Completed";
            newchild.appendChild(firstchild);
            let firstgrandchild=document.createElement("div");
            firstgrandchild.setAttribute("class","firstgrandchild");
            firstgrandchild.innerHTML=res.data[i].title;
            newchild.appendChild(firstgrandchild);
            let secgrandchild=document.createElement("div");
            secgrandchild.setAttribute("class","secgrandchild");
            secgrandchild.innerHTML=res.data[i].description;
            newchild.appendChild(secgrandchild);
             let sechild=document.createElement("div");
            sechild.setAttribute("class","sechild");
             let thirdgrandchild=document.createElement("div");
            thirdgrandchild.setAttribute("class","thirdgrandchild");
            thirdgrandchild.innerHTML=res.data[i].due;
            sechild.appendChild(thirdgrandchild);
            let fourthgrandchild=document.createElement("div");
            fourthgrandchild.setAttribute("class","fourthgrandchild");
            fourthgrandchild.innerHTML="<< Priority "+res.data[i].priority;
            sechild.appendChild(fourthgrandchild);
            let thirdchild=document.createElement("div");
            thirdchild.setAttribute("class","thirdchild");
            let fivegrandchild=document.createElement("button");
            fivegrandchild.setAttribute("class","fivegrandchild");
            if (res.data[i].completed) {
                 fivegrandchild.addEventListener("click", function () {
                     removeTodo(this.closest(".parent"));
                 });
                 fivegrandchild.innerHTML="Remove todo";
           }else{
               fivegrandchild.addEventListener("click", function() {
                    moveTodo(this.closest(".parent"));
              });
            fivegrandchild.innerHTML="Mark as complete";
           }
            thirdchild.appendChild(fivegrandchild);
            parent.appendChild(newchild);
            parent.appendChild(sechild);
            parent.appendChild(thirdchild);
            finalparent.appendChild(parent);
             let secparent=parent.cloneNode(true);
            secparent.setAttribute("class","parent");
            parent.setAttribute("data-id", res.data[i]._id);
            secparent.setAttribute("data-id", res.data[i]._id);

            if(res.data[i].completed==false){
                let fourthchild=document.querySelector("#inprogress-todo");
                 if(fourthchild)secfinalparent.removeChild(fourthchild);
                  secfinalparent.appendChild(secparent);
            }else{
                let fourthchild=document.querySelector("#done-todo");
                 if(fourthchild) thirdfinalparent.removeChild(fourthchild);
                  thirdfinalparent.appendChild(secparent);
            }
            }



           if(res.data.length>0){
            for(let i=0;i<res.data.length;i++){
                todoComp(i);
            }
           }else{
            let parent=document.querySelector("#all-todo");
            parent.style.backgroundColor="#f5f5f5";
           }




           async function moveTodo(parent){
            let todoId = parent.getAttribute("data-id");
           try{
           await axios.patch("http://localhost:3000/todo/updatetodo/"+todoId,
                 { completed: true },
                { headers: { Authorization: token } }
             );
            let finalparent=document.querySelector("#all-todo");
            let secfinalparent=document.querySelector("#inprogress-todo-task");
            let thirdfinalparent=document.querySelector("#done-todo-task");
            if (secfinalparent.contains(parent)) secfinalparent.removeChild(parent);
            let fourthchild=document.querySelector("#done-todo");
             if(fourthchild) thirdfinalparent.removeChild(fourthchild);
            thirdfinalparent.appendChild(parent);
           }catch(err){
            console.error("Failed to update todo:", err);
             alert("Error updating todo. Please try again.");
           }
           }
           async function removeTodo(parent){
              let todoId = parent.getAttribute("data-id");
              console.log(todoId);
           try{
           await axios.delete("http://localhost:3000/todo/deletetodo/"+todoId,
                { headers: { Authorization: token } }
             );
              parent.remove();

            alert("Todo deleted successfully!");
           }catch(err){
              console.error("Failed to delete todo:", err);
             alert("Error delete todo. Please try again.");
           }
        }
            let response=await axios.get("http://localhost:3000/todo/me",{
                headers:{
                    Authorization :token,
                }
            });
             username=response.data.name;
              document.getElementById("greeting").textContent = greeting+", "+username;
        }
        myinfo();
        let popup= document.querySelector("#modal");
       function presentForm(){
          popup.style.display="flex";
       }
       window.addEventListener('click', (event) => {
            if (event.target === popup) {
                    popup.style.display = 'none';
             }
       });
       function removeModal(){
        document.querySelector("#modal").style.display="none";
       }
       async function takeInfo(){
        let title=document.querySelector("#task-input").value;
        let description=document.querySelector("#task-desc").value;
        let date=document.querySelector("#due-date").value;
        let priority=document.querySelector("#priority").value;
        let status=document.querySelector("#status").value;
        let completed=false;
        await axios.post("http://localhost:3000/todo/addtodo",
                     {
                       title: title,
                       description: description,
                       due: date,
                       priority: priority,
                       status: status,
                       completed: completed,
                     },
                     {
                       headers: {
                         Authorization: token,
                       },
                     });
                     popup.style.display="none";
       }
    </script>
</body>
</html>